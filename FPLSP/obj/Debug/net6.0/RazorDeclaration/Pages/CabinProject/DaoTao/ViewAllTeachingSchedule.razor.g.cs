// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace FPLSP.Pages.CabinProject.DaoTao
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using MudBlazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Blazored.Typeahead;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using CurrieTechnologies.Razor.SweetAlert2;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using System.Text;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using System.Text.RegularExpressions;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using System.Diagnostics;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using Blazored.Toast.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Components.CabinProject;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Data.Securities;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Repositories.Interfaces.CabinProject;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Repositories.Interfaces;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Domain.Dtos;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Domain.Entities.CoresParts;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Infrastructure.ViewModels.CabinProject.BookingCabin;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Infrastructure.ViewModels.CabinProject.BookingRequest;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Infrastructure.ViewModels.CabinProject.Cabin;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Infrastructure.ViewModels.CabinProject.GroupCabin;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Infrastructure.ViewModels.CabinProject.ShiftOfCabin;

#line default
#line hidden
#nullable disable
#nullable restore
#line 19 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Infrastructure.ViewModels;

#line default
#line hidden
#nullable disable
#nullable restore
#line 20 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using FPLSP.Server.Infrastructure.ViewModels.CabinProject.TeachingSchedule;

#line default
#line hidden
#nullable disable
#nullable restore
#line 21 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using Microsoft.AspNetCore.SignalR.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
using System.Globalization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
           [Authorize(Roles = "DirectorOfTraining")]

#line default
#line hidden
#nullable disable
    [global::Microsoft.AspNetCore.Components.RouteAttribute("/Cabin/directorOfTraining/viewSchedule/{idTrainingFacilityNonDecrypt}")]
    public partial class ViewAllTeachingSchedule : global::Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(global::Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 378 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\DaoTao\ViewAllTeachingSchedule.razor"
       
    [Parameter]
    public string idTrainingFacilityNonDecrypt { get; set; }
    public string idTrainingFacility { get; set; }

    [Inject] public CryptoServices _cryptoServices { get; set; }
    [Inject] ITaskRepositories<ClassUPViewModel> subjectClassRepo { get; set; }
    [Inject] ITeachingScheduleApiClient teachingScheduleApiClient { get; set; }
    [Inject] public IBookingCabinApiClient _bookingCabinApiClient { get; set; }
    [Inject] IShiftOfCabinApiClient shiftOfCabinApiClient { get; set; }
    [Inject] IBlockRepo blockRepo { get; set; }
    [Inject] ISemesterRepo semesterRepo { get; set; }
    [Inject] private IToastService _toastService { get; set; }

    DateTime date;
    string blockName;
    string semesterName;
    List<(string, DateTime)> daysOfWeek = new List<(string, DateTime)>();
    List<ShiftOfCabinVM> listShift;
    List<ShiftOfCabinFullVM> listFullShift;
    //List<ClassUPViewModel> listSubClass;
    List<TeachingScheduleVM> listSchedule;
    List<BookingCabinVM>? listBookingCabin;

    public Guid? IdClassForDetails = Guid.Empty;
    public Guid? IdSubjectForDetails = Guid.Empty;
    public Guid? IdLecturerForDetails = Guid.Empty;
    public Guid? IdShiftForDetails = Guid.Empty;
    public Guid? IdCabinForDetails = Guid.Empty;
    public string? ClassSubjectNameForDetails;
    public string? LecturerNameForDetails;
    public string? ShiftNameForDetails;
    public string? CabinNameForDetails;
    public DateTime? TeachingDayForDetails;
    public TimeSpan? StartShiftForDetails;
    public TimeSpan? EndShiftForDetails;

    [Inject] private IBookingRequestRepo _bookingRequestRepo { get; set; }
    [Inject] private IBookingCabinApiClient _ibookingCabinApiClient { get; set; }
    [Inject] private ICabinRepo _icabinRepo { get; set; }
    [Inject] private ISubjectsSpecializedUPRepo _iSubjectsSpecializedUP { get; set; }
    [Inject] private ILecturersCPRepo _ilecturersCPRepo { get; set; }
    [Inject] private ITaskRepositories<ClassUPViewModel> _iClassRepo { get; set; }
    [Inject] private ISpecializedUPRepo _ispecializedUPRepo { get; set; }
    [Inject] private IClassSubjectApiClient _iclassSubjectApi { get; set; }
    [Inject] private ISubjectUPRepo _isubjectUPRepo { get; set; }
    [Inject] private IToastService _itoastService { get; set; }
    [Inject] private IGroupCabinRepo _igroupCabinRepo { get; set; }
    [Inject] private IShiftOfCabinApiClient _ishiftOfCabinApiClient { get; set; }
    [Inject] private ITeachingScheduleApiClient _teachingScheduleApiClient { get; set; }
    [Inject] ILecturersCPRepo lecturersCPRepo { get; set; }

    public string? IdLecturer = null;
    List<LecturersCP> listLecturer;

    private BookingCabinVM _bookingCabinVM = new BookingCabinVM();
    private List<ShiftOfCabinVM> _shiftOfCabinVMs;
    private List<SpecializedDto> _specializedDtos;
    private List<GroupCabinViewModel> _groupCabinViewModels;
    private List<CabinViewModel> _cabinViewModels;
    private List<BookingCabinVM> _listBookingCabinVM;
    private DateTime FullStartTime = DateTime.Now;
    private DateTime FullEndTime = DateTime.Now;
    private bool hiddenCabin = true;

    protected ConfirmBookingRequest Confirmsubmit { get; set; }
    protected ConfirmBookingRequest Confirmclose { get; set; }
    private string _titleRoom = "Danh sách cabin còn trống";
    private string? _contenFeedBack = "";

    string idFilterLecturer = null;
    bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            idTrainingFacility = _cryptoServices.Decrypt(idTrainingFacilityNonDecrypt.Replace("cabin", "/"));

            try
            {
                string url = "http://localhost:5001/SignalRCabinHub";
                HubConnection _connection = null;
                bool isConnected = false;
                string connectionStatus = "Closed";
                _connection = new HubConnectionBuilder()
                    .WithUrl(url)
                    .Build();

                await _connection.StartAsync();
                isConnected = true;
                connectionStatus = "Connected :-)";

                _connection.Closed += async (s) =>
                {
                    isConnected = false;
                    connectionStatus = "Disconnected";
                    await _connection.StartAsync();
                    isConnected = true;
                };

                _connection.On<string>("SignalRCabins", async (res) =>
                {
                    if (res == "Done")
                    {
                        await OnInitializedAsync();

                        await this.InvokeAsync(() => this.StateHasChanged());
                    }
                });

                _connection.On<string>("SignalRGroupCabins", async (res) =>
                {
                    if (res == "Done")
                    {
                        await OnInitializedAsync();

                        await this.InvokeAsync(() => this.StateHasChanged());
                    }
                });

                _connection.On<string>("SignalRBookingCabins", async (res) =>
                {
                    if (res == "Done")
                    {
                        await OnInitializedAsync();

                        await this.InvokeAsync(() => this.StateHasChanged());
                    }
                });

                _connection.On<string>("SignalRTeachingSchedules", async (res) =>
                {
                    if (res == "Done")
                    {
                        await OnInitializedAsync();

                        await this.InvokeAsync(() => this.StateHasChanged());
                    }
                });

                _connection.On<string>("SignalRSemesterBlocks", async (res) =>
                {
                    if (res == "Done")
                    {
                        await OnInitializedAsync();

                        await this.InvokeAsync(() => this.StateHasChanged());
                    }
                });

            }
            catch (Exception)
            {

            }
            finally
            {
                await GetTaskAsync(IdLecturer);
                await GetTasks();
            }
        }
        catch
        {
            // Lịch học rỗng
            listLecturer = new();
            listSchedule = new List<TeachingScheduleVM>();
            listShift = new List<ShiftOfCabinVM>();
            listFullShift = new List<ShiftOfCabinFullVM>();
            _specializedDtos = new();
            _groupCabinViewModels = new();
            _cabinViewModels = new();
            _listBookingCabinVM = new();
            _shiftOfCabinVMs = new();
        }
    }

    public async Task CheckLecturer(string value)
    {
        IdLecturer = value;
        await GetTaskAsync(IdLecturer);
        await GetTasks();
    }

    private async Task GetTasks()
    {
        _specializedDtos = await _ispecializedUPRepo.GetAll();
        _specializedDtos = _specializedDtos == null ? new() : _specializedDtos;
        _groupCabinViewModels = await _igroupCabinRepo.GetAllGroupCabinAsync();
        _groupCabinViewModels = _groupCabinViewModels == null ? new() : _groupCabinViewModels;
        var cabinVM = await _icabinRepo.GetAllCabinAsync();
        cabinVM = cabinVM == null ? new() : cabinVM;
        _cabinViewModels = cabinVM.Where(c => c.IdTrainingFacility == Guid.Parse(idTrainingFacility)).ToList();
        _listBookingCabinVM = await _ibookingCabinApiClient.GetAll();
        _listBookingCabinVM = _listBookingCabinVM == null ? new() : _listBookingCabinVM;
        _shiftOfCabinVMs = await _ishiftOfCabinApiClient.GetAll();
        _shiftOfCabinVMs = _shiftOfCabinVMs == null ? new() : _shiftOfCabinVMs;
    }

    private async Task GetTaskAsync(string? idLecturer)
    {
        loading = true;
        LoadDaysOfWeek(DateTime.Now);

        listFullShift = await shiftOfCabinApiClient.GetAllInformationOfShiftOfCabin();
        listLecturer = await lecturersCPRepo.GetAllLecturerAsync();
        listLecturer = listLecturer.Where(c => c.TrainingFacilitiesId == Guid.Parse(idTrainingFacility) && listFullShift.Any(x => x.IdLecturer == c.Id)).OrderBy(c => c.Email).ToList();

        listSchedule = await teachingScheduleApiClient.GetAll();
        listSchedule = listSchedule == null ? new List<TeachingScheduleVM>() : listSchedule;
        var listBlock = await blockRepo.GetAll();
        var listSemester = await semesterRepo.GetAll();

        date = DateTime.Now;
        blockName = listBlock.FirstOrDefault(c => c.Status == 0 && c.Id == listSchedule.FirstOrDefault(c => c.Status == 0).IdBlock).NameOfBlock;
        semesterName = listSemester.FirstOrDefault(c => c.Status == 0 && c.Id == listSchedule.FirstOrDefault(c => c.Status == 0).IdSemester).NameofSemester;
        LoadDaysOfWeek(date);
        listShift = await shiftOfCabinApiClient.GetAll();
        listShift = listShift == null ? new List<ShiftOfCabinVM>() : listShift.Where(c => c.Status != 1).ToList();

        if (!string.IsNullOrEmpty(idLecturer))
        {
            //listSubClass = await subjectClassRepo.GetAllClass();
            //listSubClass = listSubClass == null ? new() : listSubClass.Where(c => c.HomeroomLecturerId == Guid.Parse(idLecturer)).ToList();

            listSchedule = await teachingScheduleApiClient.GetAll();
            listSchedule = listSchedule == null ? new List<TeachingScheduleVM>() : listSchedule.Where(c => c.Status == 0 && c.IdLecturter == Guid.Parse(idLecturer)).ToList();

            listBlock = await blockRepo.GetAll();
            listSemester = await semesterRepo.GetAll();

            date = DateTime.Now;
            blockName = listBlock.FirstOrDefault(c => c.Status == 0 && c.Id == listSchedule.FirstOrDefault(c => c.Status == 0).IdBlock).NameOfBlock;
            semesterName = listSemester.FirstOrDefault(c => c.Status == 0 && c.Id == listSchedule.FirstOrDefault(c => c.Status == 0).IdSemester).NameofSemester;
            LoadDaysOfWeek(date);

            listFullShift = await shiftOfCabinApiClient.GetAllInformationOfShiftOfCabin();
            listFullShift = listFullShift == null ? new List<ShiftOfCabinFullVM>() : listFullShift.Where(c => c.IdLecturer == Guid.Parse(idLecturer)).ToList();

            listBookingCabin = await _bookingCabinApiClient.GetAll();
            listBookingCabin = listBookingCabin == null ? new() : listBookingCabin.Where(c => c.Status != 1).ToList();
        }
        else
        {
            listBookingCabin = new();
        }
        loading = false;
    }

    public async Task Notify(ShiftOfCabinFullVM obj)
    {
        IdClassForDetails = Guid.Parse(obj.IdClass.ToString());
        IdSubjectForDetails = Guid.Parse(obj.IdSubject.ToString());
        IdLecturerForDetails = Guid.Parse(obj.IdLecturer.ToString());
        IdShiftForDetails = Guid.Parse(obj.IdShiftOfCabin.ToString());
        IdCabinForDetails = obj.IdCabin == null ? Guid.Empty : Guid.Parse(obj.IdCabin.ToString());
        ClassSubjectNameForDetails = obj.ClassName + " - " + obj.SubjectCode;
        LecturerNameForDetails = obj.LecturerUserName;
        ShiftNameForDetails = obj.ShiftName;
        CabinNameForDetails = obj.CabinName;
        TeachingDayForDetails = obj.TeachingDay.Value;
        StartShiftForDetails = obj.StartTimeOfShift.Value;
        EndShiftForDetails = obj.EndTimeOfShift.Value;

        FullStartTime = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, StartShiftForDetails.Value.Hours, StartShiftForDetails.Value.Minutes, StartShiftForDetails.Value.Seconds);
        FullEndTime = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, EndShiftForDetails.Value.Hours, EndShiftForDetails.Value.Minutes, EndShiftForDetails.Value.Seconds);

        hiddenCabin = false;
    }

    private async Task ClickCloseCabin()
    {
        if (DateTime.Now < FullEndTime)
        {
            Confirmclose.Day = FullStartTime;
            Confirmclose.IdCabin = Guid.Parse(IdCabinForDetails.ToString());
            Confirmclose.IdClass = Guid.Parse(IdClassForDetails.ToString());
            Confirmclose.IdLecturer = Guid.Parse(IdLecturerForDetails.ToString());
            Confirmclose.IdSubject = Guid.Parse(IdSubjectForDetails.ToString());
            Confirmclose.ShiftName = ShiftNameForDetails;
            Confirmclose.show();
        }
        else
        {
            _toastService.ShowError($"Đã quá thời gian xếp/hủy cabin");
        }
    }

    private async Task ClickCabin(Guid idCabin)
    {
        hiddenCabin = true;
        if (DateTime.Now < FullEndTime)
        {
            IdCabinForDetails = idCabin;
            Confirmsubmit.Day = FullStartTime;
            Confirmsubmit.IdCabin = Guid.Parse(IdCabinForDetails.ToString());
            Confirmsubmit.IdClass = Guid.Parse(IdClassForDetails.ToString());
            Confirmsubmit.IdLecturer = Guid.Parse(IdLecturerForDetails.ToString());
            Confirmsubmit.IdSubject = Guid.Parse(IdSubjectForDetails.ToString());
            Confirmsubmit.ShiftName = ShiftNameForDetails;
            Confirmsubmit.show();
        }
        else
        {
            _toastService.ShowError($"Đã quá thời gian xếp/hủy cabin");
        }
    }

    public async Task OnConfirmationSubmit(string deleteconfirmed)
    {
        hiddenCabin = true;
        if (deleteconfirmed != null)
        {
            await BookCabin();
        }
    }
    public async Task BookCabin()
    {
        hiddenCabin = true;
        var listBookingCabin = await _bookingCabinApiClient.GetAll();

        var StartShift = StartShiftForDetails;
        var EndShift = EndShiftForDetails;

        var objForCreate = listBookingCabin.FirstOrDefault(c => c.SubjectId == IdSubjectForDetails && c.ClassId == IdClassForDetails && c.IdShift == IdShiftForDetails && c.IdLectuter == IdLecturerForDetails && c.IdCabin == IdCabinForDetails && c.DateCreated == new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day));
        var resBooking = false;
        var resRequest = false;

        // Tạo bookingcabin
        if (objForCreate == null)
        {
            var obj = new BookingCabinCreateVM()
                {
                    Id = Guid.NewGuid(),
                    SubjectId = Guid.Parse(IdSubjectForDetails.ToString()),
                    ClassId = Guid.Parse(IdClassForDetails.ToString()),
                    IdCabin = Guid.Parse(IdCabinForDetails.ToString()),
                    IdShift = Guid.Parse(IdShiftForDetails.ToString()),
                    IdLectuter = Guid.Parse(IdLecturerForDetails.ToString()),
                    //CheckinImage = bookingCabinVM.CheckinImage,
                    CheckinTime = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, StartShift.Value.Hours, StartShift.Value.Minutes, StartShift.Value.Seconds),
                    CheckoutTime = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, EndShift.Value.Hours, EndShift.Value.Minutes, EndShift.Value.Seconds),
                    //Note = bookingCabinVM.Note,
                    DateCreated = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day),
                    Status = 0
                };
            resBooking = await _bookingCabinApiClient.Add(obj);
        }
        else
        {
            resBooking = await _bookingCabinApiClient.Update(objForCreate.Id, Guid.Parse(IdCabinForDetails.ToString()), Guid.Parse(IdSubjectForDetails.ToString()), Guid.Parse(IdClassForDetails.ToString()), Guid.Parse(IdShiftForDetails.ToString()),
            new BookingCabinUpdateVM()
                {
                    Id = objForCreate.Id,
                    SubjectId = objForCreate.SubjectId,
                    ClassId = objForCreate.ClassId,
                    IdCabin = objForCreate.IdCabin,
                    IdShift = objForCreate.IdShift,
                    IdLectuter = objForCreate.IdLectuter,
                    CheckinImage = null,
                    CheckinTime = objForCreate.CheckinTime,
                    CheckoutTime = objForCreate.CheckoutTime,
                    Note = objForCreate.Note,
                    IndexOfBookingCabin = objForCreate.IndexOfBookingCabin,
                    DateCreated = objForCreate.DateCreated,
                    Status = 0
                });
        }

        // tạo booking request
        if (resBooking)
        {
            var StartTimeOfBR = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, StartShift.Value.Hours, StartShift.Value.Minutes, StartShift.Value.Seconds);
            var EndTimeOfBR = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, EndShift.Value.Hours, EndShift.Value.Minutes, EndShift.Value.Seconds);

            var booking = new BookingRequestCreateViewModel
                {
                    ContentOfRequest = "Đã được chọn giúp cabin",
                    IdLectuter = Guid.Parse(IdLecturerForDetails.ToString()),
                    SendingTime = DateTime.Now,
                    SubjectId = Guid.Parse(IdSubjectForDetails.ToString()),
                    ClassId = Guid.Parse(IdClassForDetails.ToString()),
                    Status = 4,
                    ContenOfFeedBack = "Đã được chọn giúp cabin",
                    StartTime = StartTimeOfBR,
                    FeedBackTime = DateTime.Now,
                    EndTime = EndTimeOfBR
                };

            // check BookingRequest.Status=0 của giảng viên bên BookingRequestPage
            // tồn tại ? tạo BookingRequest có status = 2 : status = 4
            var listBookingRequest = await _bookingRequestRepo.GetAllBookingRequestAsync();

            if (listBookingRequest.Any(c => c.IdLectuter == Guid.Parse(IdLecturerForDetails.ToString()) &&
            c.SubjectId == Guid.Parse(IdSubjectForDetails.ToString()) &&
            c.ClassId == Guid.Parse(IdClassForDetails.ToString()) &&
            c.StartTime == StartTimeOfBR &&
            c.EndTime == EndTimeOfBR
            ))
            {
                booking.Status = 2;
            }

            resRequest = await _bookingRequestRepo.CreateBookingRequest(booking);
        }

        if (resBooking && resRequest)
        {
            await Swal.FireAsync("Xếp Cabin", "Xếp Cabin Cho Lớp Học Thành Công", SweetAlertIcon.Success);
        }
        else
        {
            await Swal.FireAsync("Xếp Cabin", "Xếp Cabin Cho Lớp Học Thất Bại", SweetAlertIcon.Error);
        }
        await ResetValue();
        await GetTaskAsync(IdLecturer);
        await GetTasks();
    }

    public async Task OnConfirmationClose(string deleteconfirmed)//xác nhận thoát tab chụp ảnh
    {
        hiddenCabin = true;
        if (deleteconfirmed != null)
        {
            _contenFeedBack = deleteconfirmed;
            await CancelCabin();
        }
    }
    public async Task CancelCabin()
    {
        hiddenCabin = true;

        _contenFeedBack = _contenFeedBack == null ? "" : _contenFeedBack;
        if (_contenFeedBack.Trim().Length == 0)
        {
            _toastService.ShowError($"Không được để trống lí do hủy cabin");
        }
        else
        {
            var StartShift = StartShiftForDetails;
            var EndShift = EndShiftForDetails;

            // Xóa bookingcabin
            var listBookingCabin = await _bookingCabinApiClient.GetAll();

            var obj = listBookingCabin.FirstOrDefault(c => c.Status != 1 && c.SubjectId == IdSubjectForDetails && c.ClassId == IdClassForDetails && c.IdShift == IdShiftForDetails && c.IdLectuter == IdLecturerForDetails && c.IdCabin == IdCabinForDetails && c.DateCreated == new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day));
            var resBooking = obj == null ? true : await _bookingCabinApiClient.Delete(obj.Id, Guid.Parse(IdCabinForDetails.ToString()), Guid.Parse(IdSubjectForDetails.ToString()), Guid.Parse(IdClassForDetails.ToString()), Guid.Parse(IdShiftForDetails.ToString()));
            var resRequest = false;

            // tạo booking request
            if (resBooking)
            {
                var StartTimeOfBR = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, StartShiftForDetails.Value.Hours, StartShiftForDetails.Value.Minutes, StartShiftForDetails.Value.Seconds);
                var EndTimeOfBR = new DateTime(TeachingDayForDetails.Value.Year, TeachingDayForDetails.Value.Month, TeachingDayForDetails.Value.Day, EndShiftForDetails.Value.Hours, EndShiftForDetails.Value.Minutes, EndShiftForDetails.Value.Seconds);

                var booking = new BookingRequestCreateViewModel
                    {
                        ContentOfRequest = "Đã bị hủy cabin",
                        IdLectuter = Guid.Parse(IdLecturerForDetails.ToString()),
                        SendingTime = DateTime.Now,
                        SubjectId = Guid.Parse(IdSubjectForDetails.ToString()),
                        ClassId = Guid.Parse(IdClassForDetails.ToString()),
                        Status = 5,
                        ContenOfFeedBack = "Hủy cabin vì: " + _contenFeedBack,
                        StartTime = StartTimeOfBR,
                        FeedBackTime = DateTime.Now,
                        EndTime = EndTimeOfBR
                    };

                var listBookingRequest = await _bookingRequestRepo.GetAllBookingRequestAsync();

                if (listBookingRequest.Any(c => c.IdLectuter == Guid.Parse(IdLecturerForDetails.ToString()) &&
                    c.SubjectId == Guid.Parse(IdSubjectForDetails.ToString()) &&
                c.ClassId == Guid.Parse(IdClassForDetails.ToString()) &&
                c.StartTime == StartTimeOfBR &&
                c.EndTime == EndTimeOfBR
                ))
                {
                    booking.Status = 3;
                }
                resRequest = await _bookingRequestRepo.CreateBookingRequest(booking);
            }

            if (resBooking && resRequest)
            {
                await Swal.FireAsync("Hủy Cabin", "Hủy Cabin Cho Lớp Học Thành Công", SweetAlertIcon.Success);
            }
            else
            {
                await Swal.FireAsync("Hủy Cabin", "Hủy Cabin Cho Lớp Học Thất Bại", SweetAlertIcon.Error);
            }
        }
        await ResetValue();
        await GetTaskAsync(IdLecturer);
        await GetTasks();
    }

    private async Task ResetValue()
    {
        IdClassForDetails = Guid.Empty;
        IdSubjectForDetails = Guid.Empty;
        IdLecturerForDetails = Guid.Empty;
        IdShiftForDetails = Guid.Empty;
        IdCabinForDetails = Guid.Empty;
        ClassSubjectNameForDetails = null;
        LecturerNameForDetails = null;
        ShiftNameForDetails = null;
        CabinNameForDetails = null;
        TeachingDayForDetails = null;
        StartShiftForDetails = null;
        EndShiftForDetails = null;

        FullStartTime = DateTime.Now;
        FullEndTime = DateTime.Now;

        hiddenCabin = true;
    }

    #region Load DaysOfWeek
    public void LoadDaysOfWeek(DateTime date)
    {
        date = new DateTime(date.Year, date.Month, date.Day);
        daysOfWeek = new List<(string, DateTime)>();

        var dayOfWeek = date.DayOfWeek;
        DateTime monday = new DateTime();
        if (dayOfWeek == DayOfWeek.Sunday)
        {
            //xét chủ nhật là đầu tuần
            //return date.AddDays(1);

            //xét chủ nhật là ngày cuối tuần
            monday = date.AddDays(-6);
        }
        else
        {
            int offset = dayOfWeek - DayOfWeek.Monday;
            monday = date.AddDays(-offset);
        }
        daysOfWeek.Add(new("Thứ 2", monday));
        for (int i = 1; i < 7; i++)
        {
            if (i == 6)
            {
                daysOfWeek.Add(new($"Chủ Nhật", monday.AddDays(i)));
            }
            else
            {
                daysOfWeek.Add(new($"Thứ {i + 2}", monday.AddDays(i)));
            }
        }
    }
    #endregion

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private SweetAlertService Swal { get; set; }
    }
}
#pragma warning restore 1591
