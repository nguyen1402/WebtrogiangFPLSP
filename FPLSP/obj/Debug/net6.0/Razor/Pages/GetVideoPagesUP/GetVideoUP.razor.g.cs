#pragma checksum "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "bbb081d84469b7d5356165aba14aee3a8ce0459a"
// <auto-generated/>
#pragma warning disable 1591
namespace FPLSP.Pages.GetVideoPagesUP
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
#nullable restore
#line 1 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using MudBlazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Blazored.Typeahead;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using CurrieTechnologies.Razor.SweetAlert2;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using Blazored.Toast.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using FPLSP.Repositories.Interfaces;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using FPLSP.Server.Infrastructure.ViewModels.LessonContentUP;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using FPLSP.Server.Infrastructure.ViewModels.ResourceLinkUP;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using FPLSP.Server.Infrastructure.ViewModels.VideoHistoryVm;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using Microsoft.AspNetCore.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using Newtonsoft.Json.Linq;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
using System.Net;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
           [Authorize(Roles = "Student")]

#line default
#line hidden
#nullable disable
    [global::Microsoft.AspNetCore.Components.LayoutAttribute(typeof(MainLayout2))]
    [global::Microsoft.AspNetCore.Components.RouteAttribute("/getvideoUP/{idsubject}/{lessonId}/{lessonContenId}/{idstudent}/{backUrl}")]
    public partial class GetVideoUP : global::Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(global::Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
            __builder.OpenElement(0, "div");
            __builder.AddAttribute(1, "class", "pad");
            __builder.OpenElement(2, "a");
            __builder.AddAttribute(3, "href", 
#nullable restore
#line 14 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
              backUrl

#line default
#line hidden
#nullable disable
            );
            __builder.AddAttribute(4, "class", "btn btn-danger");
            __builder.AddMarkupContent(5, "Quay Lại");
            __builder.CloseElement();
#nullable restore
#line 16 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
     if (videohistory != null || videoID != null)
    {

#line default
#line hidden
#nullable disable
            __builder.OpenElement(6, "h5");
            __builder.AddMarkupContent(7, "Môn: ");
#nullable restore
#line (25,23)-(25,34) 24 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
__builder.AddContent(8, nameSubject);

#line default
#line hidden
#nullable disable
            __builder.AddContent(9, " - ");
#nullable restore
#line (25,38)-(25,48) 25 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
__builder.AddContent(10, nameLesson);

#line default
#line hidden
#nullable disable
            __builder.AddMarkupContent(11, " - Nội Dung: ");
#nullable restore
#line (25,62)-(25,97) 25 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
__builder.AddContent(12, lesssonContentDto.LessonContentName);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.AddMarkupContent(13, "<div class=\"row\"><div class=\"col-lg-10\"></div>\r\n                <div class=\"row col-lg-2 \"><div class=\"col-lg-3\"></div>\r\n                    <div class=\"col-lg-9\"></div></div></div>\r\n            ");
            __builder.OpenElement(14, "div");
            __builder.AddAttribute(15, "class", "row");
            __builder.AddAttribute(16, "style", " padding-top: 30px;");
            __builder.AddMarkupContent(17, "<div class=\"col-lg-1\"></div>\r\n                ");
            __builder.OpenElement(18, "div");
            __builder.AddAttribute(19, "class", "col-lg-10 d-flex justify-content-center");
            __builder.OpenElement(20, "iframe");
            __builder.AddAttribute(21, "class", "modal-xl");
            __builder.AddAttribute(22, "style", "margin-left: 40px;height: 700px;padding-top: 10px;");
            __builder.AddAttribute(23, "src", "https://www.youtube.com/embed/" + (
#nullable restore
#line 52 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
                                                                                                                                            videoID

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(24, "frameborder", "0");
            __builder.AddAttribute(25, "allow", "accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture");
            __builder.AddAttribute(26, "allowfullscreen");
            __builder.CloseElement();
            __builder.CloseElement();
            __builder.AddMarkupContent(27, "\r\n                <div class=\"col-lg-1\"></div>");
            __builder.CloseElement();
#nullable restore
#line 68 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
            }
    else
    {

#line default
#line hidden
#nullable disable
            __builder.OpenComponent<global::FPLSP.Components.LoadingIndicator>(28);
            __builder.CloseComponent();
#nullable restore
#line 72 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
    }

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
        }
        #pragma warning restore 1998
#nullable restore
#line 75 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\GetVideoPagesUP\GetVideoUP.razor"
       
    [Parameter]
    public string backUrl { get; set; }

    [Inject] private IResourceLinkUPRepo _resourceLinkUPRepo { get; set; }
    [Inject] private IToastService ToastService { get; set; }
    [Inject] private ILessonContentUPRepo _lessonContentUP { get; set; }
    [Inject] private IVideoHistoryRepo _videoHistoryRepo { get; set; }
    [Inject] private ILessonUPRepo _lessonUPRepo { get; set; }

    private string nameLesson = string.Empty;

    [Inject] private ISubjectUPRepo _subjectUPRepo { get; set; }

    private string nameSubject = string.Empty;

    private List<ResourceLinkUPViewModel> lstvideo { get; set; } = new List<ResourceLinkUPViewModel>();
    private List<LessonContentUPViewModel> lstLessonContent { get; set; } = new List<LessonContentUPViewModel>();
    private LessonContentUPViewModel lesssonContentDto { get; set; } = new LessonContentUPViewModel();
    private VideoHistoryCreateRequest _videoHistoryCreate { get; set; } = new VideoHistoryCreateRequest();
    private VideoHistoryUpdateRequest _videoHistoryUpdate { get; set; } = new VideoHistoryUpdateRequest();

    public bool check { get; set; }
    public string videoID { get; set; }
    [Parameter]
    public string lessonContenId { get; set; }
    [Parameter]
    public string idsubject { get; set; }
    [Parameter]
    public string idstudent { get; set; }
    [Parameter]
    public string lessonId { get; set; }
    public VideoHistoryViewModel videohistory { get; set; } = new VideoHistoryViewModel();
    private string a = "";

    private int b = 0;
    public int Duration { get; set; }
    public DateTime startTime { get; set; }
    protected override async Task OnInitializedAsync()
    {
        backUrl = backUrl.Replace("==", "/");
        await getTask();
        OnPlay();
        getVideoDuration(videohistory.Path);
    }

    private async Task getTask()
    {
        //if (!check)
        //{
        var lesson = await _lessonUPRepo.GetById(lessonId);
        nameLesson = lesson.LessonCode + "-" + lesson.LessonName;
        var subject = await _subjectUPRepo.GetSubjectbyId(Guid.Parse(idsubject));
        nameSubject = subject.SubjectCode + "-" + subject.SubjectName;
        //}
        //else
        //{
        //    video = lstvideo.FirstOrDefault(c => c.Id == lesssonContentDto.ResuorceLinkId);
        //    check = false;
        //}
        _videoHistoryCreate.IsBookMarked = true;
        _videoHistoryCreate.Status = 0;
        _videoHistoryCreate.IdStudent = Guid.Parse(idstudent); //idstudent
        _videoHistoryCreate.IdLessonContent = Guid.Parse(lessonContenId);
        var x = await _videoHistoryRepo.Create(_videoHistoryCreate);
        if (x = true)
        {
            videohistory = await _videoHistoryRepo.GetById(idstudent.ToString(), lessonContenId);
        }
    }
    private async void WatchLate()
    {
        _videoHistoryUpdate.IsBookMarked = true;
        _videoHistoryRepo.Update(Guid.Parse(idstudent), Guid.Parse(lessonContenId), _videoHistoryUpdate);
        videohistory.IsBookMarked = true;
        getTask();

    }
    private async void Remove()
    {
        _videoHistoryUpdate.IsBookMarked = false;
        _videoHistoryRepo.Update(Guid.Parse(idstudent), Guid.Parse(lessonContenId), _videoHistoryUpdate);
        videohistory.IsBookMarked = false;
        getTask();
    }
    private async void Next()
    {
        //if (startTime != default(DateTime))
        //{
        //    var skipTime = DateTime.Now;
        //    var seconds = (skipTime - startTime).TotalSeconds;
        //    if (seconds < Duration * 0.8)
        //    {
        //        ToastService.ShowError("Bạn phải xem tối thiểu 80% thời lượng video trước khi sang bài mới");
        //    }
        //    else
        //    {

        a = videohistory.LessonContentCode.Substring(videohistory.LessonContentCode.Length - 1, 1);
        b = int.Parse(a);
        b++;

        lesssonContentDto = lstLessonContent.FirstOrDefault(c => c.LessonContentCode == ($"Phần {b}"));
        if (lesssonContentDto == null)
        {
            b = b - 1;
            lesssonContentDto = lstLessonContent.FirstOrDefault(c => c.LessonContentCode == ($"Phần {b}"));
        }
        videohistory.LessonContentCode = "Phần " + b;
        check = true;
        OnInitializedAsync();
        //    }
        //}
        //else
        //{
        //    ToastService.ShowError("Bạn phải xem tối thiểu 80% thời lượng video trước khi sang bài mới");
        //}

    }
    private void ComeBack()
    {
        if (b < 1)
        {
            a = videohistory.LessonContentCode.Substring(videohistory.LessonContentCode.Length - 1, 1);
            b = int.Parse(a);
            lesssonContentDto = lstLessonContent.FirstOrDefault(c => c.LessonContentCode == ($"Phần {b}"));
        }
        if (b > 1)
        {
            b--;
            lesssonContentDto = lstLessonContent.FirstOrDefault(c => c.LessonContentCode == ($"Phần {b}"));
        }

        videohistory.LessonContentCode = "Phần " + b;
        check = true;
        OnInitializedAsync();
    }
    //Kiểm tra thời lượng xem
    public void OnPlay()
    {
        startTime = DateTime.Now;
    }

    public void getVideoDuration(string url)
    {
        videoID = url.Replace("https://www.youtube.com/embed/", "");
        videoID = videoID.Replace("https://www.youtube.com/watch?v=", "");
        videoID = videoID.Replace("https://youtu.be/", "");
        videoID = videoID.Substring(0, 11);
        string youtubeKey = "AIzaSyBy4O1cM43Zesp03-h1YTjj1JAhNmwEw9k";
        WebClient myDownloader = new WebClient();
        myDownloader.Encoding = System.Text.Encoding.UTF8;

        string jsonResponse = myDownloader.DownloadString(
        "https://www.googleapis.com/youtube/v3/videos?id=" + videoID + "&key=" + youtubeKey + "&part=contentDetails");

        dynamic dynamicObject = JObject.Parse(jsonResponse);
        string tmp = dynamicObject.items[0].contentDetails.duration;
        Duration = Convert.ToInt32(System.Xml.XmlConvert.ToTimeSpan(tmp).TotalSeconds);
    }

#line default
#line hidden
#nullable disable
    }
}
#pragma warning restore 1591
