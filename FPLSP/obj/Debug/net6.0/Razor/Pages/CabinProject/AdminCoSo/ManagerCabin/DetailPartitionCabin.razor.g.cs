#pragma checksum "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "35feb2b1986a41c5b4ea2f11cb5ee3fa90a69d80"
// <auto-generated/>
#pragma warning disable 1591
namespace FPLSP.Pages.CabinProject.AdminCoSo.ManagerCabin
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using MudBlazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using FPLSP.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using Blazored.Typeahead;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\_Imports.razor"
using CurrieTechnologies.Razor.SweetAlert2;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using Blazored.LocalStorage;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using Blazored.Toast.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using FPLSP.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using FPLSP.Data.Securities;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using FPLSP.Repositories.Interfaces;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using FPLSP.Server.Domain.Entities.CoresParts;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using FPLSP.Server.Infrastructure.ViewModels;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using FPLSP.Server.Infrastructure.ViewModels.LecturerCPVm;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using Microsoft.AspNetCore.Identity;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
using System.Security.Claims;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
           [Authorize(Roles = "DirectorOfTraining,Staff")]

#line default
#line hidden
#nullable disable
    [global::Microsoft.AspNetCore.Components.RouteAttribute("/detailuserCabin/{GetIdCryto}/{maxlevelCryto}/{IdCoSoCryto}")]
    public partial class DetailPartitionCabin : global::Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(global::Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
#nullable restore
#line 14 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
 if (_lstRole != null)
{

#line default
#line hidden
#nullable disable
            __builder.OpenElement(0, "div");
            __builder.AddAttribute(1, "class", "row d-flex justify-content-center");
            __builder.OpenElement(2, "div");
            __builder.AddAttribute(3, "class", "col-md-8");
            __builder.OpenElement(4, "h5");
            __builder.AddAttribute(5, "class", "fw-bold");
            __builder.AddMarkupContent(6, "Chọn Các Quyền Gán Cho :");
            __builder.OpenElement(7, "strong");
#nullable restore
#line (19,66)-(19,80) 24 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
__builder.AddContent(8, _User.UserName);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.CloseElement();
            __builder.AddMarkupContent(9, "\r\n            ");
            __builder.OpenComponent<global::MudBlazor.MudChipSet>(10);
            __builder.AddAttribute(11, "AllClosable", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<global::System.Boolean>(
#nullable restore
#line 20 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                                     true

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(12, "OnClose", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<global::Microsoft.AspNetCore.Components.EventCallback<global::MudBlazor.MudChip>>(global::Microsoft.AspNetCore.Components.EventCallback.Factory.Create<global::MudBlazor.MudChip>(this, 
#nullable restore
#line 20 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                                                    Closed

#line default
#line hidden
#nullable disable
            )));
            __builder.AddAttribute(13, "ChildContent", (global::Microsoft.AspNetCore.Components.RenderFragment)((__builder2) => {
#nullable restore
#line 22 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                 foreach (var x in @_User.ListRoles)
                {
                    if (x == "DirectorOfTraining" || x == "Staff" || x == "Lecturer")
                    {
                        if (maxlevel == "5")
                        {

#line default
#line hidden
#nullable disable
                __builder2.OpenComponent<global::MudBlazor.MudChip>(14);
                __builder2.AddAttribute(15, "Text", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<global::System.String>(
#nullable restore
#line 28 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                                            x

#line default
#line hidden
#nullable disable
                ));
                __builder2.CloseComponent();
#nullable restore
#line 29 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                        }
                        else
                        {
                            if (x == "Lecturer")
                            {

#line default
#line hidden
#nullable disable
                __builder2.OpenComponent<global::MudBlazor.MudChip>(16);
                __builder2.AddAttribute(17, "Text", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<global::System.String>(
#nullable restore
#line 34 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                                                x

#line default
#line hidden
#nullable disable
                ));
                __builder2.CloseComponent();
#nullable restore
#line 35 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                            }
                        }
                    }
                }

#line default
#line hidden
#nullable disable
            }
            ));
            __builder.CloseComponent();
            __builder.AddMarkupContent(18, "\r\n            <hr>\r\n            ");
            __builder.OpenElement(19, "div");
            __builder.AddAttribute(20, "class", "mb-3");
            __builder.AddMarkupContent(21, "<label for=\"exampleFormControlInput3\" class=\"form-label px-lg-0\">Chọn quyền :</label>");
#nullable restore
#line 46 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                 foreach (var x in _lstRole)
                {
                    if (x.Name != "LecturerFPLSP" && x.Name != "HeadOfDepartment")
                    {

#line default
#line hidden
#nullable disable
            __builder.OpenComponent<global::MudBlazor.MudButton>(22);
            __builder.AddAttribute(23, "OnClick", global::Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<global::Microsoft.AspNetCore.Components.EventCallback<global::Microsoft.AspNetCore.Components.Web.MouseEventArgs>>(global::Microsoft.AspNetCore.Components.EventCallback.Factory.Create<global::Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 50 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                                            ()=>Add(x.Name)

#line default
#line hidden
#nullable disable
            )));
            __builder.AddAttribute(24, "ChildContent", (global::Microsoft.AspNetCore.Components.RenderFragment)((__builder2) => {
                __builder2.OpenElement(25, "span");
                __builder2.AddAttribute(26, "class", "px-2");
#nullable restore
#line (50,82)-(50,88) 26 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
__builder2.AddContent(27, x.Name);

#line default
#line hidden
#nullable disable
                __builder2.CloseElement();
            }
            ));
            __builder.CloseComponent();
#nullable restore
#line 51 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                    }
                }

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.CloseElement();
            __builder.AddMarkupContent(28, "\r\n        ");
            __builder.OpenElement(29, "div");
            __builder.AddAttribute(30, "class", "row d-flex justify-content-center");
            __builder.OpenElement(31, "button");
            __builder.AddAttribute(32, "class", "btn btn-primary col-lg-6");
            __builder.AddAttribute(33, "onclick", global::Microsoft.AspNetCore.Components.EventCallback.Factory.Create<global::Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 57 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
                                                              AddRoleToUser

#line default
#line hidden
#nullable disable
            ));
            __builder.AddMarkupContent(34, "Cấp quyền");
            __builder.CloseElement();
            __builder.CloseElement();
            __builder.CloseElement();
#nullable restore
#line 60 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
}
else
{

#line default
#line hidden
#nullable disable
            __builder.OpenComponent<global::FPLSP.Components.LoadingIndicator>(35);
            __builder.CloseComponent();
#nullable restore
#line 64 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
}

#line default
#line hidden
#nullable disable
        }
        #pragma warning restore 1998
#nullable restore
#line 66 "C:\Users\Nguyen Bui\source\repos\FPLSP3\FPLSP\Pages\CabinProject\AdminCoSo\ManagerCabin\DetailPartitionCabin.razor"
 
    string cabin = "CanViewCabinProject";
    [Inject] public IUserIdentityRepo _UserIdentityRepo { get; set; }
    private UserInListRoles _User;
    [Inject]
    public IRoleUserIdentityRepo _roleUserIdentityRepo { get; set; }
    [Inject] public ILecturersCPRepo _lecturersCPRepo { get; set; }
    private List<IdentityRole> _lstRole { get; set; }
    private IdentityRole _role;

    [Inject] public NavigationManager Navigation { get; set; }
    [Inject] public IToastService toastService { get; set; }

    [Parameter]
    public string GetIdCryto { get; set; }
    [Parameter]
    public string maxlevelCryto { get; set; }
    [Parameter]
    public string IdCoSoCryto { get; set; }

    public string IdCoSo { get; set; }
    public string GetId { get; set; }
    public string maxlevel { get; set; }

    //tạo ra 1 list claim redriect
    private List<Claim> _lstRedirect = new List<Claim>();
    [Inject] public UserManager<UserSignIn> _userManager { get; set; }


    [Inject]
    public CryptoServices _cryptoServices { get; set; }
    public DetailPartitionCabin()
    {

        _User = new UserInListRoles();
        _role = new IdentityRole();
    }
    protected override async Task OnInitializedAsync()
    {
        _lstRedirect.Add(new Claim("CanViewCabinProject", "true"));

        IdCoSo = _cryptoServices.Decrypt(IdCoSoCryto.Replace("cabin", "/"));
        GetId = _cryptoServices.Decrypt(GetIdCryto.Replace("cabin", "/"));
        maxlevel = _cryptoServices.Decrypt(maxlevelCryto.Replace("cabin", "/"));
        _User = await _UserIdentityRepo.GetUserRoleById(GetId);
        _lstRole = await _roleUserIdentityRepo.GetAllRolesAsync();
        //xử lý loại trừ các role cấp cao hơn role mà dường dùng truyền vào
        if (maxlevel == "5")
        {
            foreach (var role in _lstRole.ToList())
            {
                if (role.Name != "DirectorOfTraining" && role.Name != "Staff" && role.Name != "Lecturer")
                {
                    _lstRole.Remove(role);
                }
            }
        }
        else if (maxlevel == "3")
        {
            foreach (var role in _lstRole.ToList())
            {
                if (role.Name != "Lecturer")
                {
                    _lstRole.Remove(role);
                }
            }

        }

        var let = await _lecturersCPRepo.GetAllLecturerAsync();



    }

    public void Add(string name)
    {
        if (_User.ListRoles.Any(c => c == name) == false)
        {

            _User.ListRoles.Add(name);
        }
    }
    private async void AddRoleToUser()
    {
        try
        {
            if (_User.ListRedirectClaims.Any(c => c.Type == cabin) == false)
            {
                _User.ListRedirectClaims.Add(_lstRedirect.Find(c => c.Type == cabin));
            }
            UserUpdateRolesHasClaims userUpdateRoles = new UserUpdateRolesHasClaims()
                {
                    ID = GetId,
                    Name = _User.UserName,
                    claims = _User.ListRedirectClaims,
                    RoleNames = _User.ListRoles.ToArray()
                };

            //kiểm tra xem cơ sở cũ ở trongdatabase với cơ sở mới vừa chọn có khác nhau hay không
            var getCurrentUser = await _UserIdentityRepo.GetUserRoleById(GetId);
            foreach (var user in _userManager.Users.ToList().Where(c => c.Id == GetId))
            {
                user.IdTrainingFacility = Guid.Parse(IdCoSo);
                await _userManager.UpdateAsync(user);

            }

            //cập nhật mới lại cho giảng viên
            if (userUpdateRoles.RoleNames.ToList().Any(c => c == "Lecturer"))
            {
                var update = new CreateleatureForTrainVm()
                    {
                        Id = Guid.Parse(_User.Id),
                        Email = _User.UserName,
                        IdTrain = Guid.Parse(IdCoSo)
                    };
                var all = await _lecturersCPRepo.GetAllLecturerAsync();
                foreach (var x in all.Where(c => c.Email == _User.Email))
                {
                    await _lecturersCPRepo.UpdateLecturerTrain(x.Id, update);
                }
            }
            //}
            //}

            var res = await _UserIdentityRepo.AddRolesToUser(userUpdateRoles);
            if (res)
            {

                toastService.ShowSuccess($"Cấp quyền thành công cho {_User.UserName}");
                Navigation.NavigateTo($"/listuseridenOfCabin/{_cryptoServices.Encrypt(maxlevel)}/{_cryptoServices.Encrypt(IdCoSo)}");
            }
            else
            {
                toastService.ShowError($"Cấp quyền thất bại cho {_User.UserName}");
                return;
            }
        }
        catch (Exception)
        {
            toastService.ShowError("Đã xảy ra lỗi, vui lòng thử lại");
            await OnInitializedAsync();
        }


    }
    public void Closed(MudChip chip) => _User.ListRoles.Remove(chip.Text);
    public void RemoveReDirect(MudChip chip)
    {

        _User.ListRedirectClaims.Remove((Claim)chip.Value);
    }


#line default
#line hidden
#nullable disable
    }
}
#pragma warning restore 1591
